function b(a){var b=$(".login");if(a.authResponse){gop.init();gop.data.getUserFromFB();$.publish("fb/status","connected");b.on("click",function(){})}else b.on("click",function(){FB.login(function(a){if(a.authResponse){gop.init();$.publish("fb/status","connected")}else console.log("handle user denial!")},{scope:"user_relationships,user_relationship_details,friends_relationships,friends_relationship_details ,friends_birthday"})})}$("document").ready(function(){Parse.initialize("nkmNHwnqekc0v7RpqXpjgKpHNXOPjMtTSBzy00wH","ZqgJnQ3C6gtUdxuYqxhnY0Ia923E6iMiatPd5qqa");FB.init({appId:"397573470274307",status:!0,cookie:!0,xfbml:!0,oauth:!0});FB.getLoginStatus(b)});var a=gop={debug:!1,pay_to_sort:!0,conf:{view:"list",filters:{}},storage:{},templates:{},timeout:0,rel_to_preposition:{single:"",in_a_relationship:"with",engaged:"to",married:"to","it-s_complicated":"with",in_an_open_relationship:"width",widowed:"",separated:"",divorced:"",not_listed:""},init:function(){gop.compileTemplates();gop.bindEvents();gop.data.loadConf();gop.data.statuses=_.keys(gop.rel_to_preposition);gop.ui.renderStatusFilters()},compileTemplates:function(){gop.templates.friends=_.template('<ul id="friends"><% _.each(friends, function(friend) { %><% if(typeof friend.mate == "object"){ %><li id="<%= friend.uid %>" class="rel <%=friend.sex%> hasmate" data-sex="<%=friend.sex%>"><div class="prof friend_prof"><div class="prof_cont"><a target="_blank" href="http://facebook.com/<%=friend.uid %>" class="prof_pic" style="background-image:url(<%= friend.pic %>)"></a><i class="status <%= friend.rel_code%>"></i></div></div><div class="rel_info"><div class="friend_name"><a target="_blank" href="http://facebook.com/<%=friend.uid %>"><%=friend.name %></a></div><div class="status <%=friend.rel_code %>"><%= friend.relationship_status.toLowerCase() %>&nbsp;<div class="preposition"><%= gop.data.preposition(friend.relationship_status) %></div></div><div class="friend_name mate_name"><a target="_blank" href="http://facebook.com/<%=friend.mate.uid%>"><%=friend.mate.name %></a></div></div><div class="prof mate_prof"><div class="prof_cont"><a class="prof_pic" target="_blank" href="http://facebook.com/<%=friend.mate.uid %>" style="background-image:url(<%=friend.mate.pic %>)"></a></div></div></li> <% }else{ %><li id="<%= friend.uid %>" class="rel <%=friend.sex%>" data-sex="<%=friend.sex%>"><div class="prof friend_prof"><div class="prof_cont"><a target="_blank" href="http://facebook.com/<%=friend.uid %>" class="prof_pic" style="background-image:url(<%= friend.pic %>)"></a><i class="status <%= friend.rel_code %>"></i></div></div><div class="rel_info nomate_info"><div class="friend_name"><a target="_blank" href="http://facebook.com/<%=friend.uid %>"><%=friend.name %></a></div><% if(friend.rel_code != "not_listed"){ %><div class="status <%=friend.rel_code%>"><%= friend.relationship_status.toLowerCase() %>&nbsp;</div><% } %><% if(friend.rel_code == "not_listed"){ %><div class="is isnot status">is not sharing relationship info</div><% } %></li> <% } %><% }); %></ul>')},bindEvents:function(){$.subscribe("fb/me",gop.ui.renderUser);$.subscribe("fb/me",gop.data.checkParseUser);$.subscribe("fb/status",gop.ui.setState);$.subscribe("fb/status",gop.data.getUserFromFB);$.subscribe("fb/connected",gop.connected);$.subscribe("fb/fetched_friends",gop.data.checkFilters);$.subscribe("fb/fetched_friends",gop.bindDependantEvents);$.subscribe("fb/fetched_friends",gop.data.groupByStatus);$.subscribe("fb/fetched_friends",gop.ui.addCountToFilters);$("#sort").on("click",".sort_by",function(a){window.setTimeout(function(){var a=$(".sort_tags li").filter(function(){return $(this).find("input").prop("checked")});gop.conf.filters={};a.each(function(){var a=$(this).data("category");typeof gop.conf.filters[a]=="undefined"&&(gop.conf.filters[a]=[]);gop.conf.filters[a].push($(this).data("status"))});gop.data.checkFilters()},100)});$("#view_cont").on("click",".view",function(){gop.ui.changeView($(this).attr("id"));gop.ui.bindTooltips()})},bindDependantEvents:function(a,b){$("#search_input").typeahead({source:_.map(gop.data.friends,function(a){return a.name}),event:function(a){if(a!==!1){var b=_.filter(gop.data.friends,function(b){return _.indexOf(a,b.name)>-1});gop.data.clearFilters();gop.ui.render(null,b);$("#search_cont").addClass("active")}else{gop.ui.render(null,gop.data.friends);$("#search_cont").removeClass("active")}},clear:gop.ui.clearSearch});$("#clear_search").on("click",gop.ui.clearSearch);gop.ui.bindTooltips();$("#logout").on("click",function(a){a.preventDefault();Parse.User.logOut();FB.logout(function(a){window.location=window.location})})},connected:function(a,b){gop.data.getFriends()}};gop.data={friends:{},mates:{},state:"disconnected",count:{sex:{male:0,female:0},rel_code:{}},getFriends:function(){gop.debug?friends&&gop.data.handleFriends(friends):gop.data.getFriendsFromFB()},getFriendsFromFB:function(){gop.ui.updateProgress(0);FB.api({method:"fql.multiquery",queries:{friends:"SELECT uid, name,sex ,mutual_friend_count,birthday_date, pic,relationship_status, significant_other_id FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY name",significant_others:'SELECT uid, name,pic FROM user WHERE uid in (SELECT significant_other_id FROM #friends WHERE relationship_status != "")'}},function(a){gop.ui.updateProgress(100);setTimeout(function(){gop.data.handleFriends(a)},500)})},getUserFromFB:function(){if(gop.data.me)return;gop.data.me={};FB.api("/me",function(a){gop.data.me=a;$.publish("fb/me",a)})},checkParseUser:function(a,b){var c=Parse.User.current();c?gop.data.user=c:gop.data.loginParseUser(b)},loginParseUser:function(a){Parse.User.logIn(a.username,a.id,{success:function(a){console.log(a);gop.data.user=a},error:function(b,c){gop.data.createParseUser(a)}})},createParseUser:function(a){var b=new Parse.User;b.set("username",a.username);b.set("password",a.id);b.set("payed",!1);b.signUp(null,{success:function(a){console.log(a);gop.data.user=a},error:function(a,b){console.warn("Error: "+b.code+" "+b.message)}})},handleFriends:function(a){var b=a[0].fql_result_set,c=a[1].fql_result_set;for(var d=0;d<c.length;d++)gop.data.mates[c[d].uid]=c[d];for(var d=0;d<b.length;d++){var e=b[d],f=gop.data.mates[e.significant_other_id];e.mate=f;if(e.relationship_status!=null)rel_status=e.relationship_status.toLowerCase().split(" ").join("_").split("'").join("-");else{rel_status="not_listed";e.relationship_status="undefined"}e.sex=="male"?gop.data.count.sex.male+=1:gop.data.count.sex.female+=1;typeof gop.data.count.rel_code[rel_status]=="undefined"?gop.data.count.rel_code[rel_status]=1:gop.data.count.rel_code[rel_status]+=1;e.rel_code=rel_status}gop.data.friends=b;$.publish("fb/fetched_friends")},preposition:function(a){a=a||"not_listed";a=a.toLowerCase().split(" ").join("_").split("'").join("-");return gop.rel_to_preposition[a]},groupByStatus:function(a,b){b=b||gop.data.friends;gop.data.friends_by_status=_.groupBy(b,function(a){return a.relationship_status})},filterCouples:function(){gop.data.friends_by_status=_.filter(gop.data.friends,function(a){return gop.data.friendMatchesFilters(a)});gop.ui.render(null,gop.data.friends_by_status);gop.data.saveConf()},checkFilters:function(){if(!gop.conf.filters.sex&&!gop.conf.filters.rel_code)gop.ui.render();else{gop.ui.selectFilters();gop.data.filterCouples()}},clearFilters:function(){gop.conf.filters={};gop.ui.deselectFilters()},friendMatchesFilters:function(a){var b=0;$.each(gop.conf.filters,function(c,d){var e=c;typeof a[e]!="undefined"&&$.each(d,function(c,d){a[e]==d&&(b+=1)})});return b==_.keys(gop.conf.filters).length},loadConf:function(){if(!fns.getObject("conf"))gop.data.saveConf();else{gop.conf=fns.getObject("conf");gop.ui.changeView(gop.conf.view)}},saveConf:function(){fns.setObject("conf",gop.conf)}};gop.ui={renderStatusFilters:function(){var a='<ul class="sort_tags"><% _.each(statuses,function(status){ %><li data-category="rel_code"  data-status="<%= status %>"><input type="checkbox" name="<%= status %>" id="<%= status %>"><label for="<%= status %>" class="sort_by"><i class="icon-tag"></i><span class="filter"><%= status.split("_").join(" ").split("-").join("\'") %></span> <span class="ammount"></span></label></li> <% }) %></ul>',b={statuses:gop.data.statuses},c=_.template(a,b);$("#sort").append(c)},selectFilters:function(){var a=_.reduceRight(gop.conf.filters,function(a,b){return a.concat(b)}),b=$(".sort_tags");$.each(a,function(a,c){b.find('[data-status="'+c+'"]').find("input").prop("checked","checked")})},deselectFilters:function(){var a=$(".sort_tags");a.find("input").prop("checked",!1)},addCountToFilters:function(){$(".sort_tags li").each(function(){var a=$(this).data("category"),b=$(this).data("status"),c=gop.data.count[a][b];!c>0&&(c=0);$(this).find(".ammount").html("("+c+")")})},render:function(a,b){gop.ui.renderBG();b=b||gop.data.friends;var c=gop.templates.friends({friends:b});$("#friends_body").empty().append(c);gop.ui.renderCountString(b.length);gop.ui.bindTooltips()},renderCountString:function(a){var b="",c="";gop.conf.filters.sex&&gop.conf.filters.sex.length==1&&(b=gop.conf.filters.sex.join(", "));gop.conf.filters.rel_code&&(c=gop.conf.filters.rel_code.join(", "));$("#showing").html('Showing <span class="count">'+a+"</span> "+b+" friends")},renderUser:function(a,b){b=gop.data.me;b.rel_code=b.relationship_status.toLowerCase().split(" ").join("_").split("'").join("-");var c='<div class="small_user_pic" style="background-image:url(https://graph.facebook.com/<%=user.id%>/picture)"/> Hi <%=user.first_name%>, you are <div class="small_rel_info <%=user.rel_code %>"><%=user.relationship_status%></div> | <a href="#" id="logout">logout</a>',d={user:b},e=_.template(c,d);$(".userdata").append(e).data({sex:b.sex,rel_code:b.rel_code});gop.ui.renderBG(b.rel_code,b.sex);gop.ui.updateProgress(50)},renderBG:function(a,b){$body=$("body");$body[0].className="";$body.addClass(gop.data.state);if(gop.conf.filters&&gop.conf.filters.rel_code){gop.conf.filters.sex&&gop.conf.filters.sex.length==1?b=gop.conf.filters.sex[0]:b=$(".userdata").data("sex");a=gop.conf.filters.rel_code.length==1?gop.conf.filters.rel_code[0]:"all"}else{b=$(".userdata").data("sex");a=$(".userdata").data("rel_code")}$body.addClass(a).addClass(b)},setState:function(a,b){gop.data.state=b||"disconnected";$("body").removeClass("disconnected connected").addClass(gop.data.state).attr("data-state",gop.data.state);gop.data.state=="connected"&&$.publish("fb/connected",gop.data.state)},changeView:function(a){$(".view").removeClass("selected");$("#"+a).addClass("selected");gop.conf.view=a;$("#friends_cont")[0].className=a;gop.data.saveConf()},clearSearch:function(){gop.ui.render(null,gop.data.friends);$("#search_cont").removeClass("active");$("#search_input").val("")},updateProgress:function(a){$(".bar").width(a+"%")},bindTooltips:function(){$("#friends .rel").popover({placement:function(a,b){var c=this.$element.position().left,d=$("#friends").width()/2-15<=c?"left":"right";return"inside "+d},animation:!0,content:function(){var a=$(this).html();return a},showCallback:function(){var a=$("#friends_body").scrollTop(),b=$("#friends_body").height(),c=this.$element.height(),d=this.$element.position().top,e=30;d+c+e-b>a&&$("#friends_body").animate({scrollTop:d+c+e-b},200);d<a&&$("#friends_body").animate({scrollTop:d},200)},delay:{show:300,hide:0}})}};window.fbAsyncInit=function(){$.publish("fb/status","connected")};